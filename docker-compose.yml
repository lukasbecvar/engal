# docker compose configuration defines local development stack

# docker network config
networks:
    dev:
        driver: bridge

services:
    # composer service for managing php dependencies
    composer:
        image: composer:latest
        container_name: becvar_site_composer
        working_dir: /app
        volumes:
            - ./backend:/app
        networks:
            - dev
        command: composer install --ignore-platform-reqs

    # database container
    mysql:
        image: mysql:8.0.43
        container_name: engal_mysql
        restart: always
        environment:
            - MYSQL_ROOT_PASSWORD=root
        mem_limit: 1g
        volumes:
            - ./.docker/configs/mysqld.cnf:/etc/mysql/conf.d/mysqld.cnf
            - ./.docker/services/mysql_database:/var/lib/mysql
            - ./.docker/services/log:/var/log
        ports:
            - "3306:3306"
        networks:
            - dev

    # api server container
    php:
        build:
            context: .
            dockerfile: ./.docker/Dockerfile
        container_name: engal_backend_api
        restart: always
        mem_limit: 4g
        depends_on:
            - mysql
            - minio
        environment:
            - DATABASE_HOST=mysql
        volumes:
            - ./.docker/configs/apache-api.conf:/etc/apache2/sites-available/000-default.conf
            - ./.docker/configs/php.ini:/usr/local/etc/php/php.ini:ro
            - ./.docker/services/log:/var/log
            - ./backend/:/var/www
        ports:
            - "1337:80"
        networks:
            - dev
        command: |
            bash -c "while :; do php bin/console messenger:consume async -vv; sleep 10; done & apache2-foreground"

    # frontend container
    frontend:
        image: node:latest
        container_name: engal_frontend
        restart: always
        mem_limit: 1g
        volumes:
            - ./frontend:/app
        ports:
            - "80:3000"
            - "3000:3000" # fix for dev websocket re-map
        networks:
            - dev 
        depends_on:
            - mysql
            - php
        working_dir: /app 
        command: npm start --loglevel=error

    # minio s3-compatible object storage
    minio:
        image: minio/minio:latest
        container_name: engal_minio
        restart: always
        environment:
            - MINIO_ROOT_USER=engal
            - MINIO_ROOT_PASSWORD=engalsecret
            - MINIO_KMS_SECRET_KEY=minio-backend-key:xUj+nCB1PHDD0duxCfl8URGolPfKCwC9UDf1NBxcI+s=
        volumes:
            - ./.docker/services/minio-data:/data
        ports:
            - "9000:9000"  # S3 API
            - "9001:9001"  # web console
        networks:
            - dev
        command: server /data --console-address ":9001"

    # helper to create bucket on start
    minio-setup:
        image: minio/mc:latest
        container_name: engal_minio_setup
        depends_on:
            - minio
        entrypoint: >
            /bin/sh -c "
            mc alias set engal-s3 http://minio:9000 engal engalsecret && 
            mc mb --ignore-existing engal-s3/engal-media &&
            mc mb --ignore-existing engal-s3/engal-media-test
            exit 0"
        networks:
            - dev
